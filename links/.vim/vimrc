filetype plugin indent on
syntax enable

set autoindent
" Allow backspacing over everything in insert mode.
set backspace=indent,eol,start

" Indent with spaces instead of tabs
set smarttab
set tabstop=8
set softtabstop=4
set shiftwidth=4
set expandtab

" Timeout for mappings
set timeout
set timeoutlen=500
" Timeout for key codes
set ttimeout
set ttimeoutlen=50

set incsearch
set hlsearch

" Do not recognize octal numbers for Ctrl-A and Ctrl-X
set nrformats-=octal

set history=1000
set clipboard=unnamedplus

let igVimPath = split(&rtp, ',')[0] . '/'
let g:netrw_home=igVimPath . 'volatile'
set viminfo='20,<100,:100,%,n~/.vim/volatile/.viminfo

set scrolloff=5
set sidescroll=1
set sidescrolloff=5

set mouse=a
set showcmd
" Wrap long lines at the end of a word
set linebreak
" Left/right movement to the prev./next line also
set whichwrap=b,s,<,>,[,]
set listchars=tab:>\ ,trail:-,extends:>,precedes:<,nbsp:+,eol:$
" Show @@@ in the last line if it is truncated.
set display=truncate
" Highlight strings inside C comments
let c_comment_strings=1

set wildmenu
set wildmode=longest:full,full

" Use Tab in mappings
set wildcharm=<Tab>

set ignorecase
" Case insensitive completion of file/dirs
set wildignorecase

" Map Q to q and Q! to q!
command! -bang  Q q<bang>

" Break undo sequence on Space, Tab and Enter
inoremap <Space> <Space><C-g>u
inoremap <Tab> <Tab><C-g>u
inoremap <CR> <CR><C-g>u
" Make it possible to undo CTRL-U in insert mode
inoremap <C-U> <C-G>u<C-U>

" Diff between written and current states
command! DiffOrig vert new | set bt=nofile | r ++edit # | 0d_ | diffthis | wincmd p | diffthis

set suffixes+=.aux,.bbl,.blg,.brf,.cb,.dvi,.idx,.ilg,.ind,.inx,.jpg,.log,.out,.png,.toc
set suffixes-=.h,.obj

nnoremap <Space> <nop>
let mapleader="\<Space>"

let autoload_plug_path = igVimPath . 'autoload/plug.vim'
if empty(glob(autoload_plug_path))
  silent execute '!curl -fLo ' . autoload_plug_path . ' --create-dirs
    \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
  autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif
unlet autoload_plug_path

call plug#begin(igVimPath . 'volatile/plugged')
Plug 'junegunn/fzf.vim'
Plug 'https://gitlab.com/protesilaos/tempus-themes-vim.git'
call plug#end()

if $TERM=~'linux'
    colorscheme default
else
    colorscheme tempus_dawn
    if $TERM=~'xterm'
        " see modifyOtherKeys
        let &t_TI = ""
        let &t_TE = ""
    endif
endif

let g:terminal_color_0  = '#4e4e4e'
let g:terminal_color_1  = '#d68787'
let g:terminal_color_2  = '#5f865f'
let g:terminal_color_3  = '#d8af5f'
let g:terminal_color_4  = '#85add4'
let g:terminal_color_5  = '#d7afaf'
let g:terminal_color_6  = '#87afaf'
let g:terminal_color_7  = '#d0d0d0'
let g:terminal_color_8  = '#626262'
let g:terminal_color_9  = '#d75f87'
let g:terminal_color_10 = '#87af87'
let g:terminal_color_11 = '#ffd787'
let g:terminal_color_12 = '#add4fb'
let g:terminal_color_13 = '#ffafaf'
let g:terminal_color_14 = '#87d7d7'
let g:terminal_color_15 = '#e4e4e4'

set shortmess+=Ia
set noshowmode
set noruler
set laststatus=2
set statusline=
set statusline+=%1*
set statusline+=%{StatuslineMode()}
set statusline+=%9*
set statusline+=\ 
set statusline+=%m
set statusline+=\ 
set statusline+=%r
set statusline+=\ 
set statusline+=%F
set statusline+=%=
set statusline+=%y
set statusline+=\ 
set statusline+=%{&ff}
set statusline+=\ 
set statusline+=%{strlen(&fenc)?&fenc:'none'}
set statusline+=\ 
set statusline+=%c
set statusline+=:
set statusline+=%l
set statusline+=/
set statusline+=%L
set statusline+=\ 
set statusline+=%P
hi User1 ctermbg=lightgreen ctermfg=black guibg=lightgreen guifg=black
hi User9 ctermbg=black ctermfg=white guibg=black guifg=white

function! StatuslineMode()
    let l:mode=mode()
    if l:mode==#"n"
        return "NORMAL"
    elseif l:mode==?"v"
        return "VISUAL"
    elseif l:mode==#"i"
        return "INSERT"
    elseif l:mode==#"R"
        return "REPLACE"
    elseif l:mode==?"s"
        return "SELECT"
    elseif l:mode==#"t"
        return "TERMINAL"
    elseif l:mode==#"c"
        return "COMMAND"
    elseif l:mode==#"!"
        return "SHELL"
    endif
endfunction

augroup vimStartup
        au!

        " When editing a file, always jump to the last known cursor position.
        " Don't do it when the position is invalid, when inside an event handler
        " (happens when dropping a file on gvim) and for a commit message (it's
        " likely a different one than last time).
        autocmd BufReadPost *
                    \ if line("'\"") >= 1 && line("'\"") <= line("$") && &ft !~# 'commit'
                    \ |   exe "normal! g`\""
                    \ | endif

    augroup END


let g:fzfIgMenu_dict = {
            \ "Toggle list": #{f: "call ighelper#ToggleBoolOpt('list')", k: "<Leader>tl"},
            \ "Toggle wrap": #{f: "call ighelper#ToggleBoolOpt('wrap')",},
            \ "Toggle hlsearch": #{f: "call ighelper#ToggleBoolOpt('hlsearch')",},
            \ "Convert to DOS": #{f: "set ff=dos",},
            \ "Convert to Unix": #{f: "set ff=unix",},
            \ "Search in runtime": #{f: "call SearchInRuntime()",},
            \ "Find file in runtime": #{f: "call FindFileInRuntime()",},
            \ "Format JSON": #{f: "%!python -m json.tool",},
            \ }
let g:fzfIgMenu_createCmd = 1
let g:fzfIgMenu_cmdPrefix = 'Ig'

nmap <Leader><F2> <Plug>FzfIgMenuOpen

set hidden
set autoread

function! SearchInRuntime() abort
    call fzf#vim#grep("rg --column --line-number --no-heading --color=always '' " . g:igVimPath . ' /usr/share/vim', 1) 
endfunction

function! FindFileInRuntime() abort
    call fzf#run({'sink': 'e', 'source': "fd . " . g:igVimPath . ' /usr/share/vim'})
endfunction

packadd! matchit

" Make shift-insert work like in Xterm
if has('gui_running')
    map <S-Insert> <MiddleMouse>
    map! <S-Insert> <MiddleMouse>
endif
