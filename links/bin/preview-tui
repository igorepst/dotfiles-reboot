#!/bin/bash

function process() {
    local fname="${1}"
    tput reset
    tput rmam # no wrapping
    local lines=$(($(tput lines) - 1))
    if [[ -d "${fname}" ]]; then
        # shellcheck disable=SC2012
        ls -AgGhF --group-directories-first --color=always "${fname}" | head -n ${lines}
    else
        local cols mimetype ext
        cols=$(tput cols)
        ext="${fname##*.}"
        [ -n "$ext" ] && ext="${ext,,}" # to lower
        case "$ext" in
            zip | zst)
                ~/.zsh/plugins/archive/lsarchive "${fname}" | head -n ${lines}
                ;;
            *)
                mimetype=$(file -bL --mime-type "${fname}")
                case "$mimetype" in
                    image/*)
#                         magick identify -format '%[width] %[height]' Screenshot_20200727_203946.png
# if small, use --scale-up for icat
                        kitty +kitten icat --silent --place "${cols}x${lines}@0x0" --scale-up "${fname}"
                        ;;
                    *)
                        #                 local encoding=$(file -bL --mime-encoding "${fname}")
                        #                 if [ "${encoding}" = 'binary' ]; then
                        #                     echo Binary file
                        #                 else
                        bat --color=always --style=plain --line-range=:${lines} "${fname}" 2> /dev/null
                        ;;
                        #                 fi
                esac
                ;;
        esac
    fi
    tput cup 0 0 # cursor to 0x0
}

function main() {
    local pipe="${PREVIEW_TUI_FIFO}"
    if [[ -z "$pipe" ]] || [[ ! -p "$pipe" ]]; then exit 1; fi
    trap 'rm -f $pipe' EXIT

    local fname procpid
    while true; do
        if read -r fname < "$pipe"; then
            [ -n "${procpid}" ] && kill "${procpid}"
            process "${fname}" &
            procpid=$!
        fi
    done
}

main "$@"
