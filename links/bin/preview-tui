#!/bin/bash

pipe="${PREVIEW_TUI_FIFO}"

if [[ -z "$pipe" ]] || [[ ! -p "$pipe" ]]; then exit 1; fi

trap "rm -f $pipe" EXIT

function process(){
    local fname=${1}
    tput reset
    if [[ -d "${fname}" ]]; then
        (ls -AgGhF --group-directories-first --color=always "${fname}" | head -n ${lines})
    else
        local mimetype
        mimetype=$(file -bL --mime-type "${fname}")
        case "$mimetype" in
            image/*)
                kitty +kitten icat --silent --place ${cols}x${lines}@0x0 "${fname}"
                ;;
            *)
                local encoding
                encoding=$(file -bL --mime-encoding "${fname}")
                if [ "${encoding}" = 'binary' ]; then
                    echo Binary file
                else
                    bat --theme="igAnsi" --color=always --style=plain --line-range=:${lines} "${fname}" 2>/dev/null
                fi
                ;;
        esac
    fi
}

function main(){
    local cols lines fname procpid 
    cols=$(tput cols)
    lines=$(tput lines)
    while true
    do
        if read fname < "$pipe"; then
            [ -n "${procpid}" ] && kill "${procpid}"
            process "${fname}" &
            procpid=$!
        fi
    done
}

main "$@"
